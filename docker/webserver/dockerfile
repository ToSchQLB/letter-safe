FROM php:5.6-apache

#install modules
RUN apt-get update && apt-get -y install \
        tesseract-ocr \
        tesseract-ocr-deu \
        tesseract-ocr-eng \
        imagemagick \
        poppler-utils \
        wget \
        git \
        zlib1g-dev \
        && docker-php-ext-install mbstring
        && docker-php-ext-install zip
        && docker-php-ext-install gd
        && docker-php-ext-install mysqli

COPY ./install-composer.sh /var/www/html/

RUN cd /var/www/html \
    && wget -q https://getcomposer.org/composer.phar \
    && git clone https://github.com/toschqlb/letter-safe \
    && cd letter-safe \
    && php ../composer.phar install \
    && { \
        echo '<?php'; \
        echo 'return ['; \
        echo '    "class" => "yii\db\Connection",'; \
        echo '    "dsn" => "mysql:host=${LETTERSAFE_DB_SERVER};dbname=${LETTERSAFE_DB_DB}",'; \
        echo '    "username" => "${LETTERSAFE_DB_USER}",'; \
        echo '    "password" => "${LETTERSAFE_DB_PASSWORD}",'; \
        echo '    "charset" => "utf8",'; \
        echo '];'; \
    } > config/db.php \
    && php yii migrate

WORKDIR /var/www/html/letter-safe


EXPOSE 80/tcp
